<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>File Processing Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: #f5f5f5;
          padding: 20px;
        }

        .dashboard { max-width: 1200px; margin: 0 auto; }

        .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 { font-size: 2.5em; margin-bottom: 10px; }

        .connection-status {
          display: inline-block;
          padding: 5px 15px;
          border-radius: 20px;
          font-size: 0.9em;
          font-weight: bold;
        }
        .connected { background-color: #4CAF50; color: white; }
        .disconnected { background-color: #f44336; color: white; }

        .stats-overview {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .stat-card {
          background: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          border-left: 4px solid #667eea;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }

        .files-container {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 20px;
        }

        .file-card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }
        .file-header { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .progress-bar-container {
          background: #eee;
          border-radius: 8px;
          overflow: hidden;
          height: 20px;
          margin: 10px 0;
        }
        .progress-bar {
          height: 100%;
          background: linear-gradient(90deg, #667eea, #764ba2);
          width: 0%;
          color: white;
          font-size: 0.8em;
          text-align: center;
          line-height: 20px;
          transition: width 0.3s ease;
        }
        .file-stats { font-size: 0.9em; color: #555; margin-top: 10px; }
        .file-stats div { margin-bottom: 4px; }
        .status { font-weight: bold; margin-top: 8px; }
        .completed { color: #4CAF50; }
        .failed { color: #f44336; }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="header">
        <h1>File Processing Dashboard</h1>
        <span class="connection-status disconnected" id="connection">Disconnected</span>
    </div>

    <!-- Overview stats (aggregated) -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number" id="total-read">0</div>
            <div class="stat-label">Total Read</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-write">0</div>
            <div class="stat-label">Total Written</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-skip">0</div>
            <div class="stat-label">Total Skipped</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="active-files">0</div>
            <div class="stat-label">Active Files</div>
        </div>
    </div>

    <!-- File cards -->
    <div class="files-container" id="files"></div>
</div>

<script>
    const connectionEl = document.getElementById("connection");
    const filesContainer = document.getElementById("files");
    const totals = { read:0, write:0, skip:0 };
    const fileCards = {};

    // open SSE stream (multiplexed endpoint: /stream/all)
    const es = new EventSource("/stream/all");

    es.onopen = () => {
      connectionEl.textContent = "Connected";
      connectionEl.classList.remove("disconnected");
      connectionEl.classList.add("connected");
    };

    es.onerror = () => {
      connectionEl.textContent = "Disconnected";
      connectionEl.classList.remove("connected");
      connectionEl.classList.add("disconnected");
    };

    es.onmessage = (event) => {
      const ev = JSON.parse(event.data);
      updateFile(ev);
    };

    function updateFile(ev) {
      let card = fileCards[ev.jobExecutionId];
      if (!card) {
        card = document.createElement("div");
        card.className = "file-card";
        card.id = "file-" + ev.jobExecutionId;
        card.innerHTML = `
          <div class="file-header">${ev.fileName}</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="bar-${ev.jobExecutionId}">0%</div>
          </div>
          <div class="file-stats">
            <div>Read: <span id="read-${ev.jobExecutionId}">0</span></div>
            <div>Write: <span id="write-${ev.jobExecutionId}">0</span></div>
            <div>Skip: <span id="skip-${ev.jobExecutionId}">0</span></div>
            <div>Filter: <span id="filter-${ev.jobExecutionId}">0</span></div>
            <div>ETA: <span id="eta-${ev.jobExecutionId}">--</span></div>
            <div class="status" id="status-${ev.jobExecutionId}">Running...</div>
          </div>
        `;
        filesContainer.appendChild(card);
        fileCards[ev.jobExecutionId] = card;
      }

      // update stats
      document.getElementById("read-" + ev.jobExecutionId).textContent = ev.readCount;
      document.getElementById("write-" + ev.jobExecutionId).textContent = ev.writeCount;
      document.getElementById("skip-" + ev.jobExecutionId).textContent = ev.skipCount;
      document.getElementById("filter-" + ev.jobExecutionId).textContent = ev.filterCount;
      document.getElementById("eta-" + ev.jobExecutionId).textContent = ev.estimatedRemaining || "--";

      // update totals
      totals.read += ev.readCount;
      totals.write += ev.writeCount;
      totals.skip += ev.skipCount;
      document.getElementById("total-read").textContent = totals.read;
      document.getElementById("total-write").textContent = totals.write;
      document.getElementById("total-skip").textContent = totals.skip;
      document.getElementById("active-files").textContent = Object.keys(fileCards).length;

      // progress bar
      const pct = Math.max(0, Math.min(100, ev.percentComplete || 0));
      const bar = document.getElementById("bar-" + ev.jobExecutionId);
      bar.style.width = pct + "%";
      bar.textContent = pct.toFixed(0) + "%";

      // status
      if (pct >= 100) {
        document.getElementById("status-" + ev.jobExecutionId).textContent = "Completed";
        document.getElementById("status-" + ev.jobExecutionId).classList.add("completed");
      }
    }
</script>
</body>
</html>